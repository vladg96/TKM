<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Takamol AI Aviation Dispute Platform</title>
    <style>
        :root {
            --background: #070713;
            --foreground: #ffffff;
            --brand: #5a5cff;
            --brand-600: #4336f5;
            --surface: #1a1a2e;
            --surface-hover: #252541;
            --border: #2a2a4a;
            --text-muted: #a1a1aa;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--foreground);
        }

        .main-layout {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 340px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: #3b4bb8;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--foreground);
            line-height: 1.3;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-section {
            flex: 1;
            padding: 16px 0;
        }

        .nav-item {
            padding: 16px 24px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--foreground);
            margin-bottom: 6px;
            border-radius: 0 8px 8px 0;
            margin-right: 12px;
            min-height: 60px;
        }

        .nav-item:hover {
            background: var(--surface-hover);
        }

        .nav-item.active {
            background: rgba(90, 92, 255, 0.1);
            border-left-color: var(--brand);
            color: var(--brand);
        }

        .nav-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-icon {
            font-size: 18px;
            width: 20px;
        }

        .content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .content-header {
            margin-bottom: 32px;
        }

        .content-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .content-subtitle {
            color: var(--text-muted);
            font-size: 16px;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .card-header {
            padding: 24px 24px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 24px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--foreground);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--foreground);
            font-size: 14px;
        }

        .form-input, .form-select, .form-textarea {
            background: var(--surface-hover);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px 16px;
            color: var(--foreground);
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(90, 92, 255, 0.1);
        }

        .form-input.error, .form-select.error, .form-textarea.error {
            border-color: var(--error);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .form-input.valid, .form-select.valid, .form-textarea.valid {
            border-color: var(--success);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .field-hint {
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 4px;
        }

        .validation-message {
            color: var(--error);
            font-size: 12px;
            font-weight: 500;
            min-height: 18px;
        }

        .validation-message.success {
            color: var(--success);
        }

        .char-counter {
            font-size: 12px;
            color: var(--text-muted);
            text-align: right;
            margin-top: 4px;
        }

        .char-counter.warning {
            color: var(--warning);
        }

        .char-counter.error {
            color: var(--error);
        }

        .verification-result {
            margin-top: 20px;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid;
        }

        .verification-result.verified {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
            color: var(--success);
        }

        .verification-result.suspicious {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
            color: var(--warning);
        }

        .verification-result.blocked {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--error);
            color: var(--error);
        }

        .verification-result.requires-manual-review {
            background: rgba(90, 92, 255, 0.1);
            border-color: var(--brand);
            color: var(--brand);
        }

        .verification-result h4 {
            margin-bottom: 8px;
            font-size: 16px;
        }

        .verification-details {
            margin-top: 12px;
            font-size: 14px;
            opacity: 0.9;
        }

        .verification-score {
            margin-top: 8px;
            font-size: 12px;
            opacity: 0.8;
        }

        .upload-zones {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--surface);
        }

        .upload-zone:hover {
            border-color: var(--brand);
            background: rgba(90, 92, 255, 0.05);
        }

        .upload-zone.has-files {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .upload-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--foreground);
            font-size: 18px;
        }

        .upload-subtitle {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .file-list {
            margin-top: 16px;
            text-align: left;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--surface-hover);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--foreground);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-remove {
            color: var(--error);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .file-remove:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-primary {
            background: var(--brand);
            color: white;
        }

        .btn-primary:hover {
            background: var(--brand-600);
        }

        .btn-secondary {
            background: var(--surface-hover);
            color: var(--foreground);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .start-button {
            background: var(--brand);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 200px;
        }

        .start-button:hover {
            background: var(--brand-600);
        }

        .start-button:disabled {
            background: #374151;
            cursor: not-allowed;
        }

        .ai-badge {
            background: linear-gradient(45deg, var(--brand), var(--brand-600));
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--brand);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        /* Decision Tree Styles */
        .decision-tree {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .decision-step {
            padding: 20px;
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .decision-step.processing {
            border-color: var(--brand);
            background: rgba(90, 92, 255, 0.05);
        }

        .decision-step.passed {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .decision-step.failed {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .decision-step.warning {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.05);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .step-icon {
            font-size: 20px;
        }

        .step-title {
            font-weight: 600;
            flex: 1;
        }

        .step-status {
            font-size: 18px;
        }

        .step-details {
            color: var(--text-muted);
            font-size: 14px;
            margin-left: 44px;
        }

        /* Timeline Styles */
        .timeline {
            position: relative;
            padding-left: 24px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .timeline-event {
            position: relative;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--surface-hover);
            border-radius: 8px;
            margin-left: 16px;
        }

        .timeline-event::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 20px;
            width: 8px;
            height: 8px;
            background: var(--brand);
            border-radius: 50%;
        }

        .event-date {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .event-title {
            font-weight: 600;
            margin: 4px 0;
        }

        .event-description {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .event-source {
            font-size: 12px;
            color: var(--brand);
        }

        /* Case Summary Styles */
        .case-header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 2px solid var(--border);
        }

        .case-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .case-subtitle {
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .case-id-header {
            font-weight: 600;
            color: var(--brand);
            margin-top: 8px;
        }

        .summary-section {
            margin-bottom: 32px;
        }

        .section-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--brand);
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }

        .summary-table th,
        .summary-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .summary-table th {
            background: var(--surface-hover);
            font-weight: 600;
            width: 30%;
        }

        .summary-paragraph {
            margin-bottom: 16px;
            line-height: 1.6;
        }

        /* Status Items */
        .status-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--surface-hover);
            border-radius: 6px;
        }

        .status-label {
            font-weight: 600;
            color: var(--text-muted);
        }

        .status-value {
            font-weight: 600;
            color: var(--brand);
        }

        /* Consent Styles */
        .consent-section {
            max-width: 800px;
        }

        .consent-items {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .consent-item {
            padding: 20px;
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .consent-item:hover {
            border-color: var(--brand);
            background: rgba(90, 92, 255, 0.02);
        }

        .consent-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
        }

        .consent-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            cursor: pointer;
        }

        .consent-text strong {
            display: block;
            margin-bottom: 8px;
            color: var(--foreground);
        }

        .consent-text p {
            color: var(--text-muted);
            line-height: 1.5;
            margin: 0;
        }

        /* Signature Styles */
        .signature-section {
            max-width: 600px;
        }

        .typed-signature {
            margin-top: 16px;
        }

        .typed-signature input {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--surface-hover);
            color: var(--foreground);
        }

        .typed-signature input:focus {
            border-color: var(--brand);
            outline: none;
        }

        /* Loading States */
        .loading-summary,
        .loading-timeline,
        .loading-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .loading-summary .spinner,
        .loading-timeline .spinner,
        .loading-placeholder .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--brand);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @media (max-width: 1024px) {
            .form-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .upload-zones {
                grid-template-columns: 1fr;
            }

            .sidebar {
                width: 300px;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .nav-section {
                display: flex;
                overflow-x: auto;
                padding: 8px 16px;
            }
            
            .nav-item {
                white-space: nowrap;
                margin-right: 8px;
                border-radius: 8px;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            
            .nav-item.active {
                border-left: none;
                border-bottom-color: var(--brand);
            }
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <div class="sidebar">
            <!-- Logo and Header in Sidebar -->
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo">تكامل<br>Takamol</div>
                    <div class="logo-text">AI Aviation Dispute Platform</div>
                </div>
                <div class="header-actions">
                    <span class="ai-badge">AI Powered</span>
                    <button class="btn btn-secondary btn-sm" onclick="resetPlatform()">Reset</button>
                    <button class="btn btn-primary btn-sm" onclick="exportResults()" id="export-btn" style="display: none;">Export</button>
                </div>
            </div>

            <!-- Navigation -->
            <div class="nav-section">
                <div style="padding: 0 24px 16px; color: var(--text-muted); font-size: 12px; text-transform: uppercase; font-weight: 600; letter-spacing: 1px;">
                    Workflow Steps
                </div>
                
                <div class="nav-item active" onclick="showModule('upload')">
                    <span class="nav-icon">📝</span>
                    <div>
                        <div>Submit Case</div>
                        <div style="font-size: 11px; color: var(--text-muted); font-weight: normal;">Identity & Details</div>
                    </div>
                </div>
                
                <div class="nav-item disabled" id="nav-eligibility" onclick="showModule('eligibility')">
                    <span class="nav-icon">✅</span>
                    <div>
                        <div>Eligibility Assessment</div>
                        <div style="font-size: 11px; color: var(--text-muted); font-weight: normal;">CDRC Decision Tree</div>
                    </div>
                </div>
                
                <div class="nav-item disabled" id="nav-regulations" onclick="showModule('regulations')">
                    <span class="nav-icon">📋</span>
                    <div>
                        <div>Case Summary & Timeline</div>
                        <div style="font-size: 11px; color: var(--text-muted); font-weight: normal;">Legal Documentation</div>
                    </div>
                </div>
                
                <div class="nav-item disabled" id="nav-valuation" onclick="showModule('valuation')">
                    <span class="nav-icon">📄</span>
                    <div>
                        <div>Document Analysis</div>
                        <div style="font-size: 11px; color: var(--text-muted); font-weight: normal;">AI Processing</div>
                    </div>
                </div>
                
                <div class="nav-item disabled" id="nav-responses" onclick="showModule('responses')">
                    <span class="nav-icon">✅</span>
                    <div>
                        <div>Consent & Completion</div>
                        <div style="font-size: 11px; color: var(--text-muted); font-weight: normal;">Final Submission</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Upload Module -->
            <div id="upload-module" class="module">
                <div class="content-header">
                    <h1 class="content-title">Submit Dispute Case</h1>
                    <p class="content-subtitle">Verify your identity and provide dispute information</p>
                </div>

                <!-- Step 1: Consumer Identity Verification -->
                <div class="card" id="basic-info-section">
                    <div class="card-header">
                        <div class="card-title">Step 1: Consumer Identity Verification</div>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="consumer-name">Full Name *</label>
                                <input type="text" id="consumer-name" class="form-input" placeholder="Enter full name" required>
                                <div class="validation-message" id="name-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="consumer-id">ID/Passport Number *</label>
                                <input type="text" id="consumer-id" class="form-input" placeholder="Enter ID or passport number" required>
                                <div class="validation-message" id="id-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="consumer-phone">Phone Number *</label>
                                <input type="tel" id="consumer-phone" class="form-input" placeholder="+966xxxxxxxxx" required>
                                <div class="validation-message" id="phone-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="consumer-email">Email Address *</label>
                                <input type="email" id="consumer-email" class="form-input" placeholder="email@example.com" required>
                                <div class="validation-message" id="email-error"></div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 32px;">
                            <button class="btn btn-primary" id="verify-identity-btn" onclick="verifyIdentity()">
                                <span id="verify-text">🛡️ Verify Identity & Continue</span>
                                <span id="verify-loading" class="loading hidden">
                                    <span class="spinner"></span>
                                    Verifying...
                                </span>
                            </button>
                        </div>

                        <div id="verification-result" class="verification-result" style="display: none;">
                            <!-- Verification result will be shown here -->
                        </div>
                    </div>
                </div>

                <!-- Step 2: Flight Details (Hidden until verification passes) -->
                <div class="card dispute-section" id="flight-details-section" style="display: none;">
                    <div class="card-header">
                        <div class="card-title">Step 2: Flight Information</div>
                        <div class="verification-required-badge" style="background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;">
                            ✅ Identity Verified
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="booking-ref">Booking Reference *</label>
                                <input type="text" id="booking-ref" class="form-input" placeholder="AB12CD" maxlength="6" required>
                                <small class="field-hint">6 alphanumeric characters (e.g., AB12CD)</small>
                                <div class="validation-message" id="booking-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="flight-number">Flight Number *</label>
                                <input type="text" id="flight-number" class="form-input" placeholder="SV123" required>
                                <div class="validation-message" id="flight-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="flight-date">Flight Date *</label>
                                <input type="date" id="flight-date" class="form-input" required>
                                <small class="field-hint">Must be within last 12 months</small>
                                <div class="validation-message" id="date-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="route">Route</label>
                                <input type="text" id="route" class="form-input" placeholder="RUH → JED">
                                <div class="validation-message" id="route-error"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Dispute Details (Hidden until verification passes) -->
                <div class="card dispute-section" id="dispute-details-section" style="display: none;">
                    <div class="card-header">
                        <div class="card-title">Step 3: Dispute Details</div>
                        <div class="verification-required-badge" style="background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;">
                            ✅ Identity Verified
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="dispute-category">Category of Dispute *</label>
                            <select id="dispute-category" class="form-select" required>
                                <option value="">Select dispute category</option>
                                <option value="delayed-flight">Delayed Flight</option>
                                <option value="cancelled-flight">Cancelled Flight</option>
                                <option value="lost-baggage">Lost Baggage</option>
                                <option value="refund-request">Refund Request</option>
                            </select>
                            <div class="validation-message" id="category-error"></div>
                        </div>
                        <div class="form-group">
                            <label for="dispute-description">Describe what happened *</label>
                            <textarea id="dispute-description" class="form-textarea" placeholder="Please describe your issue in detail..." rows="4" minlength="20" maxlength="1000" required></textarea>
                            <small class="field-hint">20-1000 characters</small>
                            <div class="char-counter">0/1000</div>
                            <div class="validation-message" id="description-error"></div>
                        </div>
                        <div class="form-group">
                            <label for="desired-resolution">Desired Resolution</label>
                            <textarea id="desired-resolution" class="form-textarea" placeholder="What outcome are you seeking?" rows="3" maxlength="500"></textarea>
                            <small class="field-hint">Up to 500 characters</small>
                            <div class="char-counter">0/500</div>
                            <div class="validation-message" id="resolution-error"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Document Upload (Hidden until verification passes) -->
                <div class="card dispute-section" id="document-upload-section" style="display: none;">
                    <div class="card-header">
                        <div class="card-title">Step 4: Supporting Documents</div>
                        <div class="verification-required-badge" style="background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;">
                            ✅ Identity Verified
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="upload-zones">
                            <div class="upload-zone" data-type="complaints" id="complaints-zone">
                                <div class="upload-icon">📄</div>
                                <div class="upload-title">Complaint Documents</div>
                                <div class="upload-subtitle">Primary complaint, passenger statements</div>
                                <div class="file-list" id="complaints-files"></div>
                            </div>

                            <div class="upload-zone" data-type="proof" id="proof-zone">
                                <div class="upload-icon">📎</div>
                                <div class="upload-title">Proof Documents</div>
                                <div class="upload-subtitle">Tickets, receipts, correspondence</div>
                                <div class="file-list" id="proof-files"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Final Submission (Hidden until all steps complete) -->
                <div class="dispute-section" id="final-submission-section" style="display: none; text-align: center; margin-top: 32px;">
                    <button class="start-button" id="start-processing" disabled onclick="startProcessing()">
                        <span id="start-text">Submit Case for Analysis</span>
                        <span id="start-loading" class="loading hidden">
                            <span class="spinner"></span>
                            Processing...
                        </span>
                    </button>
                </div>
            </div>

            <!-- Eligibility Assessment Module -->
            <div id="eligibility-module" class="module hidden">
                <div class="content-header">
                    <h1 class="content-title">Eligibility Assessment</h1>
                    <p class="content-subtitle">Systematic evaluation following CDRC decision tree criteria</p>
                </div>

                <!-- Decision Tree Process -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Decision Tree Process <span class="ai-badge">Automated</span></div>
                        <div class="status-badge" id="final-eligibility-status">Processing</div>
                    </div>
                    <div class="card-body">
                        <div class="decision-tree">
                            <div class="decision-step" id="step-mandatory">
                                <div class="step-header">
                                    <span class="step-icon">📋</span>
                                    <span class="step-title">1. All Mandatory Fields Present?</span>
                                    <span class="step-status" id="status-mandatory">⏳</span>
                                </div>
                                <div class="step-details" id="details-mandatory">Checking required consumer info, flight details, and dispute category...</div>
                            </div>

                            <div class="decision-step" id="step-booking">
                                <div class="step-header">
                                    <span class="step-icon">🎫</span>
                                    <span class="step-title">2. Booking Exists & Date In-Window?</span>
                                    <span class="step-status" id="status-booking">⏳</span>
                                </div>
                                <div class="step-details" id="details-booking">Validating booking reference format and 12-month window...</div>
                            </div>

                            <div class="decision-step" id="step-category">
                                <div class="step-header">
                                    <span class="step-icon">📝</span>
                                    <span class="step-title">3. Category Covered Under Policy?</span>
                                    <span class="step-status" id="status-category">⏳</span>
                                </div>
                                <div class="step-details" id="details-category">Verifying dispute category is covered by regulations...</div>
                            </div>

                            <div class="decision-step" id="step-documents">
                                <div class="step-header">
                                    <span class="step-icon">📎</span>
                                    <span class="step-title">4. Supporting Documents Uploaded?</span>
                                    <span class="step-status" id="status-documents">⏳</span>
                                </div>
                                <div class="step-details" id="details-documents">Checking for required complaint and proof documents...</div>
                            </div>

                            <div class="decision-step" id="step-jurisdiction">
                                <div class="step-header">
                                    <span class="step-icon">⚖️</span>
                                    <span class="step-title">5. Falls Under Consumer Protection Regulation?</span>
                                    <span class="step-status" id="status-jurisdiction">⏳</span>
                                </div>
                                <div class="step-details" id="details-jurisdiction">Determining GACA jurisdiction and regulatory coverage...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Final Decision -->
                <div class="card" id="final-decision-card" style="display: none;">
                    <div class="card-header">
                        <div class="card-title">Final Decision</div>
                        <div class="status-badge" id="decision-outcome">Pending</div>
                    </div>
                    <div class="card-body">
                        <div id="decision-content">
                            <div class="decision-result" id="decision-details"></div>
                            <div class="next-steps" id="next-steps"></div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="runEligibilityAssessment()">Run Assessment</button>
                    <button class="btn btn-success" onclick="approveAssessment()" id="approve-btn" style="display: none;">Approve Decision</button>
                </div>
            </div>

            <!-- Case Summary & Timeline Module -->
            <div id="regulations-module" class="module hidden">
                <div class="content-header">
                    <h1 class="content-title">Case Summary & Timeline</h1>
                    <p class="content-subtitle">Complete case documentation and event timeline for regulatory review</p>
                </div>

                <!-- Case Header -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Case Summary Document <span class="ai-badge">Auto-Generated</span></div>
                    </div>
                    <div class="card-body">
                        <div class="case-summary-document" id="case-summary-content">
                            <div class="loading-summary">
                                <div class="spinner"></div>
                                <p>Generating case summary...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeline Generator -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Event Timeline <span class="ai-badge">AI Generated</span></div>
                    </div>
                    <div class="card-body">
                        <div class="timeline-container" id="timeline-content">
                            <div class="loading-timeline">
                                <div class="spinner"></div>
                                <p>Extracting timeline from documents...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="generateCaseSummary()">Generate Complete Summary</button>
                    <button class="btn btn-success" onclick="approveCaseSummary()">Approve & Finalize</button>
                </div>
            </div>

            <!-- Document Analysis Module -->
            <div id="valuation-module" class="module hidden">
                <div class="content-header">
                    <h1 class="content-title">Document Analysis & Processing</h1>
                    <p class="content-subtitle">AI-powered document analysis, metadata extraction, and timeline generation</p>
                </div>

                <!-- Document Processing Status -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Document Processing Status <span class="ai-badge">AI Processing</span></div>
                    </div>
                    <div class="card-body">
                        <div id="processing-status-content">
                            <div class="processing-overview">
                                <div class="status-summary">
                                    <div class="status-item">
                                        <span class="status-label">Total Documents:</span>
                                        <span class="status-value" id="total-docs">0</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Processed:</span>
                                        <span class="status-value" id="processed-docs">0</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Timeline Events:</span>
                                        <span class="status-value" id="timeline-events-count">0</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Evidence Items:</span>
                                        <span class="status-value" id="evidence-items-count">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="processAllDocuments()">🔍 Process All Documents</button>
                    <button class="btn btn-success" onclick="approveDocAnalysis()">✅ Approve Analysis</button>
                </div>
            </div>

            <!-- Consent & Completion Module -->
            <div id="responses-module" class="module hidden">
                <div class="content-header">
                    <h1 class="content-title">Consent Capture & Case Completion</h1>
                    <p class="content-subtitle">Final case review, consumer consent, and regulatory submission</p>
                </div>

                <!-- Case Review Summary -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Final Case Review <span class="ai-badge">Complete Analysis</span></div>
                    </div>
                    <div class="card-body">
                        <div class="review-summary" id="review-summary-content">
                            <div class="loading-placeholder">
                                <div class="spinner"></div>
                                <p>Preparing case review...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Consent Capture -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Consumer Consent & Authorization</div>
                    </div>
                    <div class="card-body">
                        <div class="consent-section">
                            <div class="consent-items">
                                <div class="consent-item">
                                    <label class="consent-checkbox">
                                        <input type="checkbox" id="consent-data-processing" required>
                                        <span class="checkmark"></span>
                                        <div class="consent-text">
                                            <strong>Data Processing & Analysis</strong>
                                            <p>I consent to the processing of my personal data and uploaded documents by Takamol AI platform for the purpose of dispute resolution analysis and regulatory review under GACA jurisdiction.</p>
                                        </div>
                                    </label>
                                </div>

                                <div class="consent-item">
                                    <label class="consent-checkbox">
                                        <input type="checkbox" id="consent-regulatory-submission" required>
                                        <span class="checkmark"></span>
                                        <div class="consent-text">
                                            <strong>Regulatory Submission</strong>
                                            <p>I authorize the submission of this case to the General Authority of Civil Aviation (GACA) and relevant regulatory bodies for official review and determination.</p>
                                        </div>
                                    </label>
                                </div>

                                <div class="consent-item">
                                    <label class="consent-checkbox">
                                        <input type="checkbox" id="consent-accuracy" required>
                                        <span class="checkmark"></span>
                                        <div class="consent-text">
                                            <strong>Information Accuracy Declaration</strong>
                                            <p>I declare that all information provided is true and accurate to the best of my knowledge. I understand that providing false information may result in case dismissal and potential legal consequences.</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- E-Signature -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Electronic Signature</div>
                    </div>
                    <div class="card-body">
                        <div class="signature-section">
                            <div class="typed-signature">
                                <input type="text" id="typed-signature" class="form-input" placeholder="Type your full name as your electronic signature">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="validateConsent()" id="validate-btn">📋 Validate Consent</button>
                    <button class="btn btn-success" onclick="submitCase()" id="submit-btn" disabled>🚀 Submit to GACA</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let uploadedFiles = {
            complaints: [],
            proof: []
        };
        let formData = {};
        let caseId = null;
        let verificationResult = null;
        let eligibilityResults = {};
        let currentDecision = null;
        let caseSummaryData = {};
        let timelineEvents = [];

        // Form Validation Rules (updated for consumer-only verification)
        const validationRules = {
            'consumer-name': {
                required: true,
                minLength: 2,
                pattern: /^[a-zA-Z\s\u0600-\u06FF]+$/,
                message: 'Name must contain only letters and spaces'
            },
            'consumer-id': {
                required: true,
                minLength: 6,
                message: 'ID/Passport must be at least 6 characters'
            },
            'consumer-phone': {
                required: true,
                pattern: /^(\+966|966|0)?[5-9]\d{8}$/,
                message: 'Enter valid Saudi phone number'
            },
            'consumer-email': {
                required: true,
                pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                message: 'Enter valid email address'
            },
            'booking-ref': {
                required: true,
                length: 6,
                pattern: /^[A-Z0-9]{6}$/,
                message: 'Booking reference must be exactly 6 alphanumeric characters (e.g., AB12CD)'
            },
            'flight-number': {
                required: true,
                pattern: /^[A-Z]{2}\d{1,4}$/,
                message: 'Flight number format: XY123 (2 letters + numbers)'
            },
            'flight-date': {
                required: true,
                dateRange: 365,
                message: 'Flight date must be within last 12 months'
            },
            'dispute-category': {
                required: true,
                message: 'Please select a dispute category'
            },
            'dispute-description': {
                required: true,
                minLength: 20,
                maxLength: 1000,
                message: 'Description must be between 20-1000 characters'
            },
            'desired-resolution': {
                maxLength: 500,
                message: 'Resolution text cannot exceed 500 characters'
            }
        };

        // Initialize form validation on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeFormValidation();
            generateCaseId();
        });

        function initializeFormValidation() {
            // Add event listeners for real-time validation
            Object.keys(validationRules).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => {
                        validateField(fieldId);
                        updateSubmitButtonState();
                    });
                    field.addEventListener('blur', () => validateField(fieldId));
                }
            });

            // Character counters for textareas
            const disputeDesc = document.getElementById('dispute-description');
            const desiredRes = document.getElementById('desired-resolution');
            
            if (disputeDesc) disputeDesc.addEventListener('input', updateCharCounter);
            if (desiredRes) desiredRes.addEventListener('input', updateCharCounter);

            // Booking reference uppercase conversion
            const bookingRef = document.getElementById('booking-ref');
            if (bookingRef) {
                bookingRef.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            }

            // Flight number uppercase conversion
            const flightNumber = document.getElementById('flight-number');
            if (flightNumber) {
                flightNumber.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            }
        }

        function validateField(fieldId) {
            const field = document.getElementById(fieldId);
            const rule = validationRules[fieldId];
            const errorElement = document.getElementById(fieldId.split('-')[0] + '-error');
            
            if (!field || !rule) return true;

            const value = field.value.trim();
            let isValid = true;
            let errorMessage = '';

            // Required field check
            if (rule.required && !value) {
                isValid = false;
                errorMessage = 'This field is required';
            }
            // Length checks
            else if (rule.minLength && value.length < rule.minLength) {
                isValid = false;
                errorMessage = `Minimum ${rule.minLength} characters required`;
            }
            else if (rule.maxLength && value.length > rule.maxLength) {
                isValid = false;
                errorMessage = `Maximum ${rule.maxLength} characters allowed`;
            }
            else if (rule.length && value.length !== rule.length) {
                isValid = false;
                errorMessage = `Must be exactly ${rule.length} characters`;
            }
            // Pattern checks
            else if (rule.pattern && value && !rule.pattern.test(value)) {
                isValid = false;
                errorMessage = rule.message;
            }
            // Date range check
            else if (rule.dateRange && value) {
                const flightDate = new Date(value);
                const today = new Date();
                const maxDate = new Date();
                maxDate.setDate(today.getDate() - rule.dateRange);
                
                if (flightDate < maxDate || flightDate > today) {
                    isValid = false;
                    errorMessage = rule.message;
                }
            }

            // Update UI
            field.classList.remove('error', 'valid');
            field.classList.add(isValid ? 'valid' : 'error');
            
            if (errorElement) {
                errorElement.textContent = errorMessage;
                errorElement.classList.toggle('success', isValid && value);
            }

            return isValid;
        }

        function updateCharCounter() {
            const field = this;
            const maxLength = field.getAttribute('maxlength') || 1000;
            const currentLength = field.value.length;
            
            // Find the char counter (next sibling or following element)
            let counter = field.nextElementSibling;
            while (counter && !counter.classList.contains('char-counter')) {
                counter = counter.nextElementSibling;
            }
            
            if (counter) {
                counter.textContent = `${currentLength}/${maxLength}`;
                counter.classList.remove('warning', 'error');
                
                if (currentLength > maxLength * 0.9) {
                    counter.classList.add('warning');
                }
                if (currentLength >= maxLength) {
                    counter.classList.add('error');
                }
            }
        }

        function generateCaseId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 100000).toString().padStart(5, '0');
            caseId = `CS-${year}-${random}`;
            return caseId;
        }

        // Identity Verification Functions (simplified for consumer-only)
        async function verifyIdentity() {
            // Validate basic consumer fields only
            const basicFields = ['consumer-name', 'consumer-id', 'consumer-phone', 'consumer-email'];
            let isValid = true;
            
            basicFields.forEach(fieldId => {
                if (!validateField(fieldId)) {
                    isValid = false;
                }
            });

            if (!isValid) {
                showError('Please fix the validation errors before proceeding.');
                return;
            }

            // Show loading state
            const verifyText = document.getElementById('verify-text');
            const verifyLoading = document.getElementById('verify-loading');
            const verifyBtn = document.getElementById('verify-identity-btn');
            
            verifyText.classList.add('hidden');
            verifyLoading.classList.remove('hidden');
            verifyBtn.disabled = true;

            try {
                // Collect basic consumer data for verification
                const verificationData = {
                    consumer: {
                        name: document.getElementById('consumer-name').value.trim(),
                        id: document.getElementById('consumer-id').value.trim(),
                        phone: document.getElementById('consumer-phone').value.trim(),
                        email: document.getElementById('consumer-email').value.trim()
                    }
                };

                // Call identity verification agent
                verificationResult = await callIdentityVerificationAgent(verificationData);
                
                // Show verification result
                displayVerificationResult(verificationResult);
                
                // Handle the result
                if (verificationResult.verification_result.status === 'blocked') {
                    showError('❌ Identity verification failed. Please review your information or contact support.');
                    // Keep subsequent sections hidden
                } else {
                    // Enable next steps for verified and suspicious cases
                    enableRestOfForm();
                    
                    if (verificationResult.verification_result.status === 'verified') {
                        showSuccess('✅ Identity verified successfully! Please continue with your flight and dispute details.');
                    } else if (verificationResult.verification_result.status === 'suspicious') {
                        showInfo('⚠️ Your case will require additional review. Please continue with your details.');
                    } else {
                        showInfo('📋 Your case will require manual review. Please continue with your details.');
                    }
                }

            } catch (error) {
                console.error('Verification error:', error);
                showError('Verification failed: ' + error.message);
            } finally {
                verifyText.classList.remove('hidden');
                verifyLoading.classList.add('hidden');
                verifyBtn.disabled = false;
            }
        }

        async function callIdentityVerificationAgent(verificationData) {
            try {
                console.log('Calling Identity Verification Agent...', verificationData);
                
                // NOTE: Update this Bearer token if it expires
                const bearerToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhY2NvdW50SWQiOiJURnpRRzRYMmE1VzZzYWZBRSIsImlhdCI6MTc0NDA0NTg5Mn0.rfid2bEEKMoXGy3LU3guR50GcmollU9A9pYLzFKV1es';
                
                // Call the real Integrail identity verification agent
                const executeResponse = await fetch('https://cloud.integrail.ai/api/TFzQG4X2a5W6safAE/agent/j4rx66Z9nmfGhHRgH/execute', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${bearerToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inputs: {
                            name: verificationData.consumer.name,
                            id: verificationData.consumer.id,
                            phone: verificationData.consumer.phone,
                            email: verificationData.consumer.email
                        }
                    })
                });

                if (!executeResponse.ok) {
                    throw new Error(`API call failed: ${executeResponse.status}`);
                }

                const executeResult = await executeResponse.json();
                console.log('Execute response:', executeResult);

                // Extract execution ID from the response
                const executionId = executeResult.execution?.id || executeResult.executionId || executeResult.id;
                
                if (!executionId) {
                    throw new Error('No execution ID returned from API');
                }

                // Poll for results
                let attempts = 0;
                const maxAttempts = 30; // 30 seconds max wait
                
                while (attempts < maxAttempts) {
                    await delay(1000); // Wait 1 second between polls
                    
                    const statusResponse = await fetch(`https://cloud.integrail.ai/api/TFzQG4X2a5W6safAE/agent/${executionId}/status`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${bearerToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!statusResponse.ok) {
                        throw new Error(`Status check failed: ${statusResponse.status}`);
                    }

                    const statusResult = await statusResponse.json();
                    console.log('Status check:', statusResult);

                    // Check if execution is complete
                    if (statusResult.status === 'completed' || statusResult.execution?.status === 'completed') {
                        // Extract the verification result from the response
                        const result = statusResult.result || statusResult.execution?.result || statusResult;
                        
                        // Ensure the result has the expected structure
                        if (result.verification_result) {
                            console.log('Identity verification completed:', result);
                            return result;
                        } else if (result.outputs && result.outputs.verification_result) {
                            console.log('Identity verification completed:', result.outputs);
                            return result.outputs;
                        } else {
                            // If structure is different, try to adapt it
                            console.log('Adapting result structure:', result);
                            return {
                                verification_result: result
                            };
                        }
                    }
                    
                    // Check for failure
                    if (statusResult.status === 'failed' || statusResult.execution?.status === 'failed') {
                        throw new Error('Agent execution failed');
                    }
                    
                    attempts++;
                }
                
                throw new Error('Timeout waiting for verification results');
                
            } catch (error) {
                console.error('Identity verification error:', error);
                
                // If real API fails, fall back to simulation for testing
                console.log('Falling back to simulation due to error');
                const result = simulateIdentityVerification(verificationData);
                return result;
            }
        }

        function simulateIdentityVerification(payload) {
            let riskScore = 0.0;
            let checks = {};

            // Identity Format Check
            const identityCheck = validateIdentityFormat(payload.consumer);
            checks.identity_format = identityCheck;
            if (!identityCheck.passed) riskScore += 0.3;

            // Contact Validation Check  
            const contactCheck = validateContactInfo(payload.consumer);
            checks.contact_validation = contactCheck;
            if (!contactCheck.passed) riskScore += 0.2;

            // Fraud Indicators Check
            const fraudCheck = checkFraudIndicators(payload);
            checks.fraud_indicators = fraudCheck;
            if (!fraudCheck.passed) riskScore += 0.5;

            // Determine status based on risk score
            let status, recommendations;
            if (riskScore <= 0.2) {
                status = 'verified';
                recommendations = 'proceed';
            } else if (riskScore <= 0.6) {
                status = 'suspicious';
                recommendations = 'manual_review';
            } else {
                status = 'blocked';
                recommendations = 'block';
            }

            return {
                verification_result: {
                    status: status,
                    confidence: Math.max(0.1, 1.0 - riskScore),
                    risk_score: riskScore,
                    checks: checks,
                    recommendations: recommendations,
                    reasoning: generateReasoningText(status, riskScore, checks),
                    next_steps: getNextSteps(status)
                }
            };
        }

        function validateIdentityFormat(consumer) {
            const issues = [];
            
            // Name validation
            if (!consumer.name || consumer.name.length < 2) {
                issues.push('Name too short or missing');
            }
            if (consumer.name && !/^[a-zA-Z\s\u0600-\u06FF]+$/.test(consumer.name)) {
                issues.push('Name contains invalid characters');
            }
            if (consumer.name && /^(test|john doe|jane doe)$/i.test(consumer.name.trim())) {
                issues.push('Suspicious test name detected');
            }

            // ID validation
            if (!consumer.id || consumer.id.length < 6) {
                issues.push('ID/Passport number too short');
            }

            return {
                passed: issues.length === 0,
                details: issues.length === 0 ? 'All identity fields properly formatted' : 'Identity format issues detected',
                issues: issues
            };
        }

        function validateContactInfo(consumer) {
            const issues = [];

            // Phone validation
            if (!consumer.phone) {
                issues.push('Phone number missing');
            } else if (!/^(\+966|966|0)?[5-9]\d{8}$/.test(consumer.phone.replace(/\s/g, ''))) {
                issues.push('Invalid phone number format');
            }

            // Email validation
            if (!consumer.email) {
                issues.push('Email address missing');
            } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(consumer.email)) {
                issues.push('Invalid email format');
            } else {
                // Check for suspicious email domains
                const suspiciousDomains = ['10minutemail', 'guerrillamail', 'tempmail', 'throwaway'];
                const emailDomain = consumer.email.split('@')[1]?.toLowerCase();
                if (suspiciousDomains.some(domain => emailDomain?.includes(domain))) {
                    issues.push('Suspicious temporary email domain');
                }
            }

            return {
                passed: issues.length === 0,
                details: issues.length === 0 ? 'Phone and email formats valid' : 'Contact validation issues',
                issues: issues
            };
        }

        function checkFraudIndicators(payload) {
            const issues = [];

            // Check for obvious test data
            if (payload.consumer.email?.includes('test') || payload.consumer.email?.includes('example')) {
                issues.push('Test email address detected');
            }

            // Check for unrealistic combinations
            if (payload.consumer.name?.toLowerCase().includes('test') || 
                payload.consumer.name?.toLowerCase().includes('fake')) {
                issues.push('Suspicious name pattern');
            }

            return {
                passed: issues.length === 0,
                details: issues.length === 0 ? 'No fraud patterns detected' : 'Potential fraud indicators found',
                issues: issues
            };
        }

        function generateReasoningText(status, riskScore, checks) {
            const failedChecks = Object.entries(checks)
                .filter(([key, check]) => !check.passed)
                .map(([key, check]) => key);

            if (status === 'verified') {
                return 'All verification checks passed successfully. Consumer identity appears legitimate.';
            } else if (status === 'suspicious') {
                return `Moderate risk detected (score: ${riskScore.toFixed(2)}). Issues found in: ${failedChecks.join(', ')}. Case requires additional monitoring but can proceed.`;
            } else {
                return `High risk detected (score: ${riskScore.toFixed(2)}). Significant issues found in: ${failedChecks.join(', ')}. Case blocked for security reasons.`;
            }
        }

        function getNextSteps(status) {
            switch (status) {
                case 'verified':
                    return 'Proceed to flight and dispute details collection';
                case 'suspicious':
                    return 'Proceed with enhanced monitoring and manual review flag';
                case 'blocked':
                    return 'Block submission and notify user to contact support';
                default:
                    return 'Manual review required';
            }
        }

        function displayVerificationResult(verificationResult) {
            const resultDiv = document.getElementById('verification-result');
            const result = verificationResult.verification_result;
            
            resultDiv.style.display = 'block';
            resultDiv.className = `verification-result ${result.status.replace('_', '-')}`;

            let iconAndTitle = '';
            let message = '';
            
            switch (result.status) {
                case 'verified':
                    iconAndTitle = '✅ Identity Verified';
                    message = `Your identity has been successfully verified with ${(result.confidence * 100).toFixed(0)}% confidence. You can now proceed with your case details.`;
                    break;
                case 'suspicious':
                    iconAndTitle = '⚠️ Additional Review Required';
                    message = `Your case has been flagged for additional review (risk score: ${(result.risk_score * 100).toFixed(0)}%). You can continue with your submission, but manual review may be required.`;
                    break;
                case 'blocked':
                    iconAndTitle = '❌ Verification Failed';
                    message = `Your submission has been blocked due to verification concerns (risk score: ${(result.risk_score * 100).toFixed(0)}%). Please review your information or contact support.`;
                    break;
                default:
                    iconAndTitle = '📋 Manual Review Required';
                    message = 'Your case requires manual review. You can continue with your submission, but additional verification may be needed.';
            }

            resultDiv.innerHTML = `
                <h4>${iconAndTitle}</h4>
                <p>${message}</p>
                <div class="verification-details">
                    <strong>Reasoning:</strong> ${result.reasoning}
                </div>
                <div class="verification-score">
                    Confidence: ${(result.confidence * 100).toFixed(0)}% | Risk Score: ${(result.risk_score * 100).toFixed(0)}%
                </div>
            `;
        }

        function enableRestOfForm() {
            // Show flight details, dispute details and document upload sections
            document.getElementById('flight-details-section').style.display = 'block';
            document.getElementById('dispute-details-section').style.display = 'block';
            document.getElementById('document-upload-section').style.display = 'block';
            document.getElementById('final-submission-section').style.display = 'block';
            
            // Initialize file upload for the now-visible zones
            initializeUpload();
            
            // Re-validate form to enable submit button if ready
            setTimeout(() => {
                updateSubmitButtonState();
            }, 100);
        }

        function updateSubmitButtonState() {
            const startButton = document.getElementById('start-processing');
            if (!startButton) return;
            
            const hasComplaintFiles = uploadedFiles.complaints.length > 0;
            const hasProofFiles = uploadedFiles.proof.length > 0;
            
            // Check if all required form fields are filled and verified
            const requiredFields = ['consumer-name', 'consumer-email', 'booking-ref', 'flight-date', 'dispute-category', 'dispute-description'];
            const formFieldsFilled = requiredFields.every(fieldId => {
                const field = document.getElementById(fieldId);
                return field && field.value.trim();
            });
            
            const isVerified = verificationResult && verificationResult.verification_result.status !== 'blocked';
            
            startButton.disabled = !(hasComplaintFiles && hasProofFiles && formFieldsFilled && isVerified);
        }

        // File Upload Functionality
        function initializeUpload() {
            const uploadZones = document.querySelectorAll('.upload-zone');
            
            uploadZones.forEach(zone => {
                // Remove existing listeners to avoid duplicates
                zone.replaceWith(zone.cloneNode(true));
            });

            // Re-select zones after cloning
            document.querySelectorAll('.upload-zone').forEach(zone => {
                zone.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.multiple = true;
                    input.accept = '.pdf,.doc,.docx';
                    
                    input.addEventListener('change', (e) => {
                        handleFiles(e.target.files, zone.dataset.type);
                    });
                    
                    input.click();
                });

                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('dragover');
                });

                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('dragover');
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('dragover');
                    handleFiles(e.dataTransfer.files, zone.dataset.type);
                });
            });
        }

        function handleFiles(files, type) {
            Array.from(files).forEach(file => {
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    if (!uploadedFiles[type].find(f => f.name === file.name)) {
                        uploadedFiles[type].push(file);
                        addFileToList(file, type);
                    }
                } else {
                    showError(`Please upload PDF files only. "${file.name}" is not supported.`);
                }
            });
            updateSubmitButtonState();
            updateUploadZones();
        }

        function addFileToList(file, type) {
            const fileList = document.getElementById(type + '-files');
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <span>📄</span>
                    <span>${file.name}</span>
                    <span style="color: var(--text-muted); font-size: 12px;">(${(file.size / 1024).toFixed(1)} KB)</span>
                </div>
                <span class="file-remove" onclick="removeFile('${file.name}', '${type}')">✕</span>
            `;
            fileList.appendChild(fileItem);
        }

        function removeFile(fileName, type) {
            uploadedFiles[type] = uploadedFiles[type].filter(f => f.name !== fileName);
            const fileList = document.getElementById(type + '-files');
            const fileItems = fileList.querySelectorAll('.file-item');
            fileItems.forEach(item => {
                if (item.textContent.includes(fileName)) {
                    item.remove();
                }
            });
            updateSubmitButtonState();
            updateUploadZones();
        }

        function updateUploadZones() {
            const hasComplaintFiles = uploadedFiles.complaints.length > 0;
            const hasProofFiles = uploadedFiles.proof.length > 0;
            
            // Update zone styles
            document.getElementById('complaints-zone').classList.toggle('has-files', hasComplaintFiles);
            document.getElementById('proof-zone').classList.toggle('has-files', hasProofFiles);
        }

        // Placeholder functions for other workflow steps
        async function startProcessing() {
            // First validate all form data
            const requiredFields = ['consumer-name', 'consumer-id', 'consumer-phone', 'consumer-email', 
                                  'booking-ref', 'flight-number', 'flight-date', 'dispute-category', 'dispute-description'];
            
            let isValid = true;
            requiredFields.forEach(fieldId => {
                if (!validateField(fieldId)) {
                    isValid = false;
                }
            });

            if (!isValid) {
                showError('Please fix all validation errors before submitting.');
                return;
            }

            // Show loading state
            const startText = document.getElementById('start-text');
            const startLoading = document.getElementById('start-loading');
            const startButton = document.getElementById('start-processing');
            
            startText.classList.add('hidden');
            startLoading.classList.remove('hidden');
            startButton.disabled = true;

            try {
                // Collect all form data including verification status
                formData = {
                    caseId: caseId,
                    consumer: {
                        name: document.getElementById('consumer-name').value.trim(),
                        id: document.getElementById('consumer-id').value.trim(),
                        phone: document.getElementById('consumer-phone').value.trim(),
                        email: document.getElementById('consumer-email').value.trim()
                    },
                    flight: {
                        bookingRef: document.getElementById('booking-ref').value.trim(),
                        flightNumber: document.getElementById('flight-number').value.trim(),
                        date: document.getElementById('flight-date').value,
                        route: document.getElementById('route').value.trim()
                    },
                    dispute: {
                        category: document.getElementById('dispute-category').value,
                        description: document.getElementById('dispute-description').value.trim(),
                        resolution: document.getElementById('desired-resolution').value.trim()
                    },
                    verification: verificationResult
                };

                showSuccess('Case submitted successfully! Moving to eligibility assessment...');
                
                // Enable navigation and show next module
                document.getElementById('nav-eligibility').classList.remove('disabled');
                document.getElementById('export-btn').style.display = 'inline-block';
                
                // Auto-navigate to eligibility after delay
                setTimeout(() => {
                    showModule('eligibility');
                    runEligibilityAssessment();
                }, 1500);
                
            } catch (error) {
                console.error('Processing error:', error);
                showError('Failed to process case: ' + error.message);
            } finally {
                startText.classList.remove('hidden');
                startLoading.classList.add('hidden');
                startButton.disabled = false;
            }
        }

        // Eligibility Assessment Functions
        async function runEligibilityAssessment() {
            const steps = ['mandatory', 'booking', 'category', 'documents', 'jurisdiction'];
            
            // Reset all steps
            steps.forEach(step => {
                document.getElementById(`step-${step}`).className = 'decision-step';
                document.getElementById(`status-${step}`).textContent = '⏳';
            });

            // Step 1: Mandatory Fields
            await simulateProcessingStep('mandatory', () => {
                const hasAllFields = formData.consumer.name && formData.consumer.id && 
                                   formData.consumer.phone && formData.consumer.email &&
                                   formData.flight.bookingRef && formData.flight.flightNumber &&
                                   formData.flight.date && formData.dispute.category &&
                                   formData.dispute.description;
                
                eligibilityResults.mandatory = hasAllFields;
                return {
                    passed: hasAllFields,
                    details: hasAllFields ? 'All mandatory fields are complete' : 'Missing required fields'
                };
            });

            // Step 2: Booking Validation
            await simulateProcessingStep('booking', () => {
                const bookingValid = /^[A-Z0-9]{6}$/.test(formData.flight.bookingRef);
                const dateValid = isWithinDateRange(formData.flight.date, 365);
                
                eligibilityResults.booking = bookingValid && dateValid;
                return {
                    passed: bookingValid && dateValid,
                    details: bookingValid && dateValid ? 
                        'Booking reference valid and within 12-month window' : 
                        'Invalid booking reference or date out of range'
                };
            });

            // Step 3: Category Validation
            await simulateProcessingStep('category', () => {
                const validCategories = ['delayed-flight', 'cancelled-flight', 'lost-baggage', 'refund-request'];
                const categoryValid = validCategories.includes(formData.dispute.category);
                
                eligibilityResults.category = categoryValid;
                return {
                    passed: categoryValid,
                    details: categoryValid ? 
                        `Category "${formData.dispute.category.replace('-', ' ')}" is covered under policy` : 
                        'Category not covered'
                };
            });

            // Step 4: Documents Check
            await simulateProcessingStep('documents', () => {
                const hasComplaintDocs = uploadedFiles.complaints.length > 0;
                const hasProofDocs = uploadedFiles.proof.length > 0;
                const docsValid = hasComplaintDocs && hasProofDocs;
                
                eligibilityResults.documents = docsValid;
                return {
                    passed: docsValid,
                    details: docsValid ? 
                        `${uploadedFiles.complaints.length} complaint and ${uploadedFiles.proof.length} proof documents uploaded` : 
                        'Missing required documents'
                };
            });

            // Step 5: Jurisdiction Check
            await simulateProcessingStep('jurisdiction', () => {
                const saudiAirlines = ['SV', 'XY', 'F3', 'G9'];
                const airlineCode = formData.flight.flightNumber.substring(0, 2);
                const underJurisdiction = saudiAirlines.includes(airlineCode);
                
                eligibilityResults.jurisdiction = underJurisdiction;
                return {
                    passed: underJurisdiction,
                    details: underJurisdiction ? 
                        `Flight ${airlineCode} falls under GACA jurisdiction` : 
                        'Flight not under Saudi consumer protection regulation'
                };
            });

            // Determine final decision
            const allPassed = Object.values(eligibilityResults).every(result => result === true);
            const decision = determineEligibilityDecision(eligibilityResults);
            displayFinalDecision(decision);
        }

        async function simulateProcessingStep(stepId, validationFunc) {
            const stepElement = document.getElementById(`step-${stepId}`);
            const statusElement = document.getElementById(`status-${stepId}`);
            const detailsElement = document.getElementById(`details-${stepId}`);
            
            stepElement.classList.add('processing');
            
            await delay(1500);
            
            const result = validationFunc();
            
            stepElement.classList.remove('processing');
            stepElement.classList.add(result.passed ? 'passed' : 'failed');
            statusElement.textContent = result.passed ? '✅' : '❌';
            detailsElement.textContent = result.details;
        }

        function determineEligibilityDecision(results) {
            if (!results.mandatory) {
                return { 
                    status: 'invalid', 
                    message: 'Case is invalid due to missing mandatory fields',
                    next: 'Notify consumer of missing fields'
                };
            }
            
            if (!results.booking) {
                return { 
                    status: 'on_hold', 
                    message: 'Case placed on hold - invalid booking or date',
                    next: 'Request valid booking information'
                };
            }
            
            if (!results.category || !results.jurisdiction) {
                return { 
                    status: 'ineligible', 
                    message: 'Case is out of scope for CDRC',
                    next: 'Notify consumer - case ineligible'
                };
            }
            
            if (!results.documents) {
                return { 
                    status: 'on_hold', 
                    message: 'Case placed on hold - missing documents',
                    next: 'Request supporting documents'
                };
            }
            
            return { 
                status: 'eligible', 
                message: 'Case is eligible for CDRC processing',
                next: 'Proceed to case summary and timeline drafting'
            };
        }

        function displayFinalDecision(decision) {
            const decisionCard = document.getElementById('final-decision-card');
            const outcomeElement = document.getElementById('decision-outcome');
            const detailsElement = document.getElementById('decision-details');
            const nextStepsElement = document.getElementById('next-steps');
            
            decisionCard.style.display = 'block';
            
            const statusColors = {
                eligible: 'var(--success)',
                ineligible: 'var(--error)',
                invalid: 'var(--error)',
                on_hold: 'var(--warning)'
            };
            
            outcomeElement.textContent = decision.status.replace('_', ' ').toUpperCase();
            outcomeElement.style.background = statusColors[decision.status];
            outcomeElement.style.color = 'white';
            outcomeElement.style.padding = '4px 12px';
            outcomeElement.style.borderRadius = '16px';
            
            detailsElement.innerHTML = `
                <h4>${decision.message}</h4>
                <p>Next Steps: ${decision.next}</p>
            `;
            
            currentDecision = decision;
            
            if (decision.status === 'eligible') {
                document.getElementById('approve-btn').style.display = 'inline-block';
            }
        }

        function approveAssessment() {
            if (currentDecision && currentDecision.status === 'eligible') {
                showSuccess('Eligibility approved! Moving to case summary generation...');
                document.getElementById('nav-regulations').classList.remove('disabled');
                setTimeout(() => {
                    showModule('regulations');
                    generateCaseSummary();
                }, 1000);
            }
        }

        // Case Summary Functions
        async function generateCaseSummary() {
            await delay(2000);
            
            const summaryContent = document.getElementById('case-summary-content');
            
            const summaryHTML = `
                <div class="case-header">
                    <h2 class="case-title">Aviation Dispute Case Summary</h2>
                    <p class="case-subtitle">General Authority of Civil Aviation (GACA)</p>
                    <p class="case-subtitle">Consumer Dispute Resolution Centre (CDRC)</p>
                    <p class="case-id-header">Case ID: ${caseId}</p>
                </div>

                <div class="summary-section">
                    <h3 class="section-header">Consumer Information</h3>
                    <table class="summary-table">
                        <tr><th>Full Name</th><td>${formData.consumer.name}</td></tr>
                        <tr><th>ID/Passport</th><td>${formData.consumer.id}</td></tr>
                        <tr><th>Phone Number</th><td>${formData.consumer.phone}</td></tr>
                        <tr><th>Email Address</th><td>${formData.consumer.email}</td></tr>
                        <tr><th>Verification Status</th><td>${verificationResult.verification_result.status}</td></tr>
                    </table>
                </div>

                <div class="summary-section">
                    <h3 class="section-header">Flight Details</h3>
                    <table class="summary-table">
                        <tr><th>Booking Reference</th><td>${formData.flight.bookingRef}</td></tr>
                        <tr><th>Flight Number</th><td>${formData.flight.flightNumber}</td></tr>
                        <tr><th>Flight Date</th><td>${new Date(formData.flight.date).toLocaleDateString()}</td></tr>
                        <tr><th>Route</th><td>${formData.flight.route || 'Not specified'}</td></tr>
                    </table>
                </div>

                <div class="summary-section">
                    <h3 class="section-header">Dispute Information</h3>
                    <p class="summary-paragraph"><strong>Category:</strong> ${formData.dispute.category.replace('-', ' ').toUpperCase()}</p>
                    <p class="summary-paragraph"><strong>Description:</strong></p>
                    <p class="summary-paragraph">${formData.dispute.description}</p>
                    <p class="summary-paragraph"><strong>Desired Resolution:</strong></p>
                    <p class="summary-paragraph">${formData.dispute.resolution || 'Not specified'}</p>
                </div>

                <div class="summary-section">
                    <h3 class="section-header">Eligibility Assessment</h3>
                    <p class="summary-paragraph"><strong>Decision:</strong> ${currentDecision.status.toUpperCase()}</p>
                    <p class="summary-paragraph"><strong>Reasoning:</strong> ${currentDecision.message}</p>
                </div>

                <div class="summary-section">
                    <h3 class="section-header">Supporting Documents</h3>
                    <p class="summary-paragraph"><strong>Complaint Documents:</strong> ${uploadedFiles.complaints.map(f => f.name).join(', ')}</p>
                    <p class="summary-paragraph"><strong>Proof Documents:</strong> ${uploadedFiles.proof.map(f => f.name).join(', ')}</p>
                </div>

                <div class="summary-section">
                    <h3 class="section-header">Regulatory Framework</h3>
                    <p class="summary-paragraph">This case falls under the jurisdiction of the General Authority of Civil Aviation (GACA) Consumer Protection Regulation.</p>
                    <p class="summary-paragraph"><strong>Applicable Regulations:</strong></p>
                    <ul>
                        <li>GACA Consumer Protection Regulation (CPR)</li>
                        <li>Saudi Aviation Consumer Rights Framework</li>
                        ${formData.flight.route && formData.flight.route.includes('→') ? '<li>Montreal Convention (for international flights)</li>' : ''}
                    </ul>
                </div>

                <div class="summary-section">
                    <h3 class="section-header">Case Certification</h3>
                    <p class="summary-paragraph">This case summary has been automatically generated by the Takamol AI Aviation Dispute Platform.</p>
                    <p class="summary-paragraph"><strong>Generated on:</strong> ${new Date().toLocaleString()}</p>
                    <p class="summary-paragraph"><strong>Platform Version:</strong> 1.0</p>
                </div>
            `;
            
            summaryContent.innerHTML = summaryHTML;
            caseSummaryData = {
                caseId: caseId,
                consumer: formData.consumer,
                flight: formData.flight,
                dispute: formData.dispute,
                eligibility: currentDecision,
                documents: uploadedFiles,
                generatedAt: new Date().toISOString()
            };

            // Generate timeline
            generateTimeline();
        }

        function generateTimeline() {
            const timelineContent = document.getElementById('timeline-content');
            
            // Simulate timeline events based on dispute type
            const baseEvents = [
                {
                    date: formData.flight.date,
                    title: 'Original Flight Date',
                    description: `Flight ${formData.flight.flightNumber} scheduled`,
                    source: 'Form submission',
                    type: 'flight'
                }
            ];

            // Add category-specific events
            if (formData.dispute.category === 'delayed-flight') {
                baseEvents.push({
                    date: formData.flight.date,
                    title: 'Flight Delay Occurred',
                    description: 'Flight delayed - passenger notified',
                    source: 'Extracted from documents',
                    type: 'issue'
                });
            } else if (formData.dispute.category === 'cancelled-flight') {
                baseEvents.push({
                    date: formData.flight.date,
                    title: 'Flight Cancellation',
                    description: 'Flight cancelled by airline',
                    source: 'Extracted from documents',
                    type: 'issue'
                });
            }

            // Add submission event
            baseEvents.push({
                date: new Date().toISOString().split('T')[0],
                title: 'Dispute Submitted',
                description: 'Case submitted to Takamol platform',
                source: 'System generated',
                type: 'submission'
            });

            timelineEvents = baseEvents.sort((a, b) => new Date(a.date) - new Date(b.date));

            // Display timeline
            const timelineHTML = `
                <div class="timeline">
                    ${timelineEvents.map(event => `
                        <div class="timeline-event">
                            <div class="event-date">${new Date(event.date).toLocaleDateString()}</div>
                            <div class="event-title">${event.title}</div>
                            <div class="event-description">${event.description}</div>
                            <div class="event-source">Source: ${event.source}</div>
                        </div>
                    `).join('')}
                </div>
                <div style="text-align: center; margin-top: 24px;">
                    <button class="btn btn-secondary" onclick="addTimelineEvent()">+ Add Event</button>
                </div>
            `;
            
            timelineContent.innerHTML = timelineHTML;
        }

        function addTimelineEvent() {
            // Simple prompt for demo - in production would be a modal
            const eventDate = prompt('Event date (YYYY-MM-DD):');
            const eventTitle = prompt('Event title:');
            const eventDescription = prompt('Event description:');
            
            if (eventDate && eventTitle) {
                timelineEvents.push({
                    date: eventDate,
                    title: eventTitle,
                    description: eventDescription || '',
                    source: 'Manual entry',
                    type: 'custom'
                });
                generateTimeline();
            }
        }

        function approveCaseSummary() {
            showSuccess('Case summary approved! Moving to document analysis...');
            document.getElementById('nav-valuation').classList.remove('disabled');
            setTimeout(() => {
                showModule('valuation');
                processAllDocuments();
            }, 1000);
        }

        // Document Analysis Functions
        async function processAllDocuments() {
            const totalDocs = uploadedFiles.complaints.length + uploadedFiles.proof.length;
            document.getElementById('total-docs').textContent = totalDocs;
            
            // Simulate processing each document
            let processed = 0;
            for (const doc of [...uploadedFiles.complaints, ...uploadedFiles.proof]) {
                await delay(1000);
                processed++;
                document.getElementById('processed-docs').textContent = processed;
            }
            
            // Update timeline and evidence counts
            document.getElementById('timeline-events-count').textContent = timelineEvents.length + 3;
            document.getElementById('evidence-items-count').textContent = Math.floor(totalDocs * 2.5);
            
            showSuccess('All documents processed successfully!');
        }

        function approveDocAnalysis() {
            showSuccess('Document analysis approved! Moving to consent & completion...');
            document.getElementById('nav-responses').classList.remove('disabled');
            setTimeout(() => {
                showModule('responses');
                prepareReviewSummary();
            }, 1000);
        }

        // Consent & Completion Functions
        function prepareReviewSummary() {
            const reviewContent = document.getElementById('review-summary-content');
            
            const reviewHTML = `
                <div class="status-summary">
                    <div class="status-item">
                        <span class="status-label">Case ID:</span>
                        <span class="status-value">${caseId}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Consumer:</span>
                        <span class="status-value">${formData.consumer.name}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Flight:</span>
                        <span class="status-value">${formData.flight.flightNumber}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Category:</span>
                        <span class="status-value">${formData.dispute.category.replace('-', ' ')}</span>
                    </div>
                </div>
                
                <div style="margin-top: 24px;">
                    <h4>Verification Status</h4>
                    <p>Identity: ${verificationResult.verification_result.status}</p>
                    <p>Eligibility: ${currentDecision.status}</p>
                    <p>Documents: Processed</p>
                    <p>Ready for submission: Yes</p>
                </div>
            `;
            
            reviewContent.innerHTML = reviewHTML;
        }

        function validateConsent() {
            const requiredConsents = ['consent-data-processing', 'consent-regulatory-submission', 'consent-accuracy'];
            const allChecked = requiredConsents.every(id => document.getElementById(id).checked);
            const hasSignature = document.getElementById('typed-signature').value.trim();
            
            if (allChecked && hasSignature) {
                showSuccess('Consent validated successfully!');
                document.getElementById('submit-btn').disabled = false;
            } else {
                showError('Please provide all required consents and signature.');
            }
        }

        async function submitCase() {
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            await delay(2000);
            
            const gacaRef = `GACA-${new Date().getFullYear()}-${Math.floor(Math.random() * 100000).toString().padStart(5, '0')}`;
            
            showSuccess(`🎉 Case submitted successfully to GACA!\n\nReference Number: ${gacaRef}\n\nYou will receive confirmation via email within 24 hours.`);
            
            // Update all navigation items to show completed
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('disabled');
            });
            
            submitBtn.textContent = '✅ Submitted to GACA';
        }

        // Utility Functions
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function isWithinDateRange(date, days) {
            const flightDate = new Date(date);
            const today = new Date();
            const maxDate = new Date();
            maxDate.setDate(today.getDate() - days);
            
            return flightDate >= maxDate && flightDate <= today;
        }

        // Module Navigation
        function showModule(moduleId) {
            // Hide all modules
            document.querySelectorAll('.module').forEach(module => {
                module.classList.add('hidden');
            });
            
            // Show selected module
            document.getElementById(moduleId + '-module').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the correct nav item
            let targetNavItem = null;
            if (moduleId === 'upload') {
                targetNavItem = document.querySelector('.nav-item');
            } else {
                targetNavItem = document.getElementById(`nav-${moduleId}`);
            }
            
            if (targetNavItem && !targetNavItem.classList.contains('disabled')) {
                targetNavItem.classList.add('active');
            }
        }

        function resetPlatform() {
            if (confirm('Are you sure you want to reset the platform? All data will be lost.')) {
                location.reload();
            }
        }

        function exportResults() {
            const exportData = {
                caseId: caseId,
                submittedAt: new Date().toISOString(),
                consumer: formData.consumer,
                flight: formData.flight,
                dispute: formData.dispute,
                verification: verificationResult,
                eligibility: eligibilityResults,
                decision: currentDecision,
                documents: {
                    complaints: uploadedFiles.complaints.map(f => f.name),
                    proof: uploadedFiles.proof.map(f => f.name)
                },
                timeline: timelineEvents,
                caseSummary: caseSummaryData,
                platform: {
                    version: '1.0',
                    environment: 'production'
                }
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `takamol-case-${caseId}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showSuccess('Case data exported successfully!');
        }

        // Utility Functions
        function showError(message) {
            showMessage(message, 'error');
        }

        function showSuccess(message) {
            showMessage(message, 'success');
        }

        function showInfo(message) {
            showMessage(message, 'success'); // Use success styling for info
        }

        function showMessage(message, type) {
            // Remove existing messages
            document.querySelectorAll('.error-message, .success-message').forEach(el => el.remove());
            
            const messageEl = document.createElement('div');
            messageEl.className = type === 'error' ? 'error-message' : 'success-message';
            messageEl.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(messageEl, content.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }
    </script>
</body>
</html>
                
